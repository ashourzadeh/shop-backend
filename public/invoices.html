<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ù…Ø¯ÛŒØ±ÛŒØª ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ â€” Ø¨Ø§ Ø¬Ø³ØªØ¬ÙˆÛŒ Ù…Ø´ØªØ±ÛŒ Ùˆ Ù…Ø­ØµÙˆÙ„</title>
  <link rel="icon" href="ico/favicon.ico" type="image/x-icon">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#000000">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
  
  <link href="assets/font/style.css" rel="stylesheet">
  <!-- Ø¯Ø± head -->
<link rel="stylesheet" href="assets/css/menu.css">
<link rel="stylesheet" href="assets/css/print.css" media="print">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
<script src="https://cdn.jsdelivr.net/npm/persian-date@1.1.0/dist/persian-date.js"></script>
<script src="https://cdn.jsdelivr.net/npm/persian-date@1.1.0/dist/persian-date-format.js"></script>

  <style>
  body { background:#f7fafc;  }
  .container { margin-top:40px; max-width:1100px; }
  .card { border-radius:12px; }
  /* .table thead th { background:#41b883; color:#fff; } */
  .badge-total { font-size:1rem; }
.d-flex.justify-content-between.align-items-center.mb-3 {
    padding: 25px 15px;
    background: linear-gradient(90deg, #F765AD, #F7BAC4);
    border-radius: 10px;
    box-shadow: var(--bs-box-shadow) !important;
    margin-bottom: 22px !important;
}
#info-invoice {
    display: flex;
    align-items: flex-start;
    justify-content: center;
    align-content: center;
    gap: 14px;
    flex-direction: column;
    border-top: 2px dashed #c2c2c2;
    padding: 8px;
    margin-top: 30px !important;
}
#product-enter {
    margin-bottom: 70px !important;
    display: flex;
    align-items: center;
    justify-content: space-evenly;
}

h2.mb-0 {
    font-size: 20px;
    color: #fff;
}

button.btn.btn-success.me-2 {
    background: #f777b2;
    border-color: #f7bac4;
}
  /* Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯Ø§Øª (dropdown suggestions) */
  .suggestions {
    position: absolute;
    z-index: 2000;
    background: #fff;
    border: 1px solid #e6e6e6;
    width: 100%;
    max-height: 240px;
    overflow: auto;
    border-radius: 6px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.08);
  }
  .suggestions .item {
    padding: 8px 12px;
    cursor: pointer;
  }
  .suggestions .item:hover { background:#f1f1f1; }

  .search-wrapper { position: relative; width: 100%; }
  .small-muted { font-size: 0.9rem; color: #666; }

.text-end {
    text-align: right !important;
}

    .bg-success {
        --bs-bg-opacity: 1;
        background-color: #0dcaf0 !important;
    }

/* Ù‚Ø§Ù„Ø¨ Ú†Ø§Ù¾ Ù…Ø®ØµÙˆØµ ÙØ§Ú©ØªÙˆØ± ÙØ±ÙˆØ´Ú¯Ø§Ù‡ÛŒ */
@media print {
  body { background: #fff !important; }
  #printArea {
    width: 80mm;
    padding: 10px;
    font-size: 13px;
    font-family: sans-serif;
    direction: rtl;
  }
  #printArea table {
    width: 100%;
    border-collapse: collapse;
    font-size: 12px;
  }
  #printArea th, #printArea td {
    padding: 4px;
    border-bottom: 1px dashed #666;
  }
  .invoice-header {
    text-align: center;
    margin-bottom: 10px;
    border-bottom: 2px solid #000;
    padding-bottom: 6px;
  }
  .invoice-footer {
    border-top: 2px solid #000;
    margin-top: 10px;
    padding-top: 6px;
  }
}

</style>
</head>
<body>

<!-- Ø¯Ø± ØªÙ…Ø§Ù… ØµÙØ­Ø§Øª Ø¨Ø§Ù„Ø§ Ù‚Ø¨Ù„ Ø§Ø² <div class="container"> -->
<div id="navbar-placeholder"></div>

  <div class="container">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2 class="mb-0">ğŸ§¾ Ù…Ø¯ÛŒØ±ÛŒØª ÙØ§Ú©ØªÙˆØ±Ù‡Ø§</h2>
      <div>
        <button class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#createInvoiceModal">â• ÙØ§Ú©ØªÙˆØ± Ø¬Ø¯ÛŒØ¯</button>
        <button class="btn btn-outline-secondary" onclick="loadInvoices()">ğŸ”„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ</button>
      </div>
    </div>

    <div class="mb-3 d-flex justify-content-between">
      <input id="invoiceSearch" class="form-control w-25" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø´Ù…Ø§Ø±Ù‡/Ù…Ø´ØªØ±ÛŒ...">
    </div>

    <div class="card shadow-sm">
      <div class="card-body p-2">
        <table class="table table-striped align-middle text-center mb-0">
          <thead>
            <tr>
              <th>ID</th>
              <th>Ø´Ù…Ø§Ø±Ù‡ ÙØ§Ú©ØªÙˆØ±</th>
              <th>Ù…Ø´ØªØ±ÛŒ</th>
              <th>ØªØ§Ø±ÛŒØ®</th>
              <th>Ù…Ø¨Ù„Øº Ú©Ù„</th>
              <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
            </tr>
          </thead>
          <tbody id="invoicesTbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Ù…ÙˆØ¯Ø§Ù„ Ù†Ù…Ø§ÛŒØ´ ÙØ§Ú©ØªÙˆØ± -->
  <div class="modal fade" id="viewInvoiceModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header bg-info text-white">
          <h5 class="modal-title">ğŸ§¾ Ø¬Ø²Ø¦ÛŒØ§Øª ÙØ§Ú©ØªÙˆØ±</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="printArea">
          <div id="invoiceDetails"></div>
        </div>
        <div class="modal-footer">
          <!-- <button class="btn btn-primary" onclick="window.print()">ğŸ–¨ï¸ Ù¾Ø±ÛŒÙ†Øª</button> -->
          <button class="btn btn-secondary" data-bs-dismiss="modal">Ø¨Ø³ØªÙ†</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Ù…ÙˆØ¯Ø§Ù„ Ø§ÛŒØ¬Ø§Ø¯ ÙØ§Ú©ØªÙˆØ± -->
  <div class="modal fade" id="createInvoiceModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title">â• ÙØ§Ú©ØªÙˆØ± Ø¬Ø¯ÛŒØ¯</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <!-- CUSTOMER: searchable OR free-text -->
            <div class="col-12 col-lg-4">
              <label class="form-label">Ù…Ø´ØªØ±ÛŒ</label>
              <div class="search-wrapper">
                <input id="customerInput" class="form-control" placeholder="Ù†Ø§Ù… Ù…Ø´ØªØ±ÛŒ Ø±Ø§ ØªØ§ÛŒÙ¾ Ú©Ù† ÛŒØ§ Ø§Ø² Ù„ÛŒØ³Øª Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†">
                <div id="customerSuggestions" class="suggestions" style="display:none"></div>
                <div class="small-muted mt-1"></div>
              </div>
              <!-- Ø°Ø®ÛŒØ±Ù‡ customer id Ø¯Ø± hidden -->
              <input type="hidden" id="selectedCustomerId" value="">
    

            </div>

            <div class="col-12 col-lg-4">
              <label class="form-label">Ù…Ø§Ù„ÛŒØ§Øª</label>
              <input id="taxInput" type="number" class="form-control" value="0">
            </div>
            <div class="col-12 col-lg-4">
              <label class="form-label">ØªØ®ÙÛŒÙ</label>
              <input id="discountInput" type="number" class="form-control" value="0">
              
            </div>

            <div class="col-12">
              <hr/>
              <!-- PRODUCT search + qty -->
              <div class="mb-2" id="product-enter">
                <div class="search-wrapper w-50">
                  <input id="productSearch" class="form-control" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ù…Ø­ØµÙˆÙ„ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†Ø§Ù… ÛŒØ§ Ú©Ø¯...">
                  <div id="productSuggestions" class="suggestions" style="display:none"></div>
                </div>
                <input id="productQty" type="number" class="form-control w-25" value="1" min="1">
                <button class="btn btn-primary" id="addItemBtn">â• Ø§ÙØ²ÙˆØ¯Ù†</button>
              </div>
              
              <div class="table-responsive">
                <table class="table table-bordered">
                  <thead>
                    <tr>
                      <th>#</th>
                      <th>Ù†Ø§Ù… Ù…Ø­ØµÙˆÙ„</th>
                      <th>ØªØ¹Ø¯Ø§Ø¯</th>
                      <th>Ù‚ÛŒÙ…Øª ÙˆØ§Ø­Ø¯</th>
                      <th>Ø¬Ù…Ø¹</th>
                      <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
                    </tr>
                  </thead>
                  <tbody id="invoiceItemsTbody"></tbody>
                </table>
              </div>

              <div id="info-invoice" class="mt-3">
                <div>Ø¬Ù…Ø¹ Ø¬Ø²Ø¦ÛŒ: <span id="subtotalSpan">0</span> ØªÙˆÙ…Ø§Ù†</div>
                <div>Ù…Ø§Ù„ÛŒØ§Øª: <span id="taxSpan">0</span> ØªÙˆÙ…Ø§Ù†</div>
                <div>ØªØ®ÙÛŒÙ: <span id="discountSpan">0</span> ØªÙˆÙ…Ø§Ù†</div>
                <div class="fs-5">Ù…Ø¬Ù…ÙˆØ¹ Ù‚Ø§Ø¨Ù„ Ù¾Ø±Ø¯Ø§Ø®Øª: <span id="totalSpan" class="badge bg-success badge-total">0</span> ØªÙˆÙ…Ø§Ù†</div>
              </div>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn btn-warning" onclick="sendToPOS()">ğŸ’³ Ø§Ø±Ø³Ø§Ù„ Ù…Ø¨Ù„Øº Ø¨Ù‡ Ú©Ø§Ø±Øªâ€ŒØ®ÙˆØ§Ù†</button>

          <button id="createInvoiceBtn" class="btn btn-success">ğŸ’¾ Ø«Ø¨Øª ÙØ§Ú©ØªÙˆØ±</button>
          <button class="btn btn-secondary" data-bs-dismiss="modal">Ø§Ù†ØµØ±Ø§Ù</button>
        </div>
      </div>
    </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
/* ====== ØªÙ†Ø¸ÛŒÙ…Ø§Øª API ====== */
const apiProducts = 'http://localhost:3000/api/products';
const apiInvoices = 'http://localhost:3000/api/invoices';
const apiCustomers = 'http://localhost:3000/api/customers';

let products = [];        // Ù„ÛŒØ³Øª Ù…Ø­ØµÙˆÙ„Ø§Øª Ø§Ø² Ø³Ø±ÙˆØ±
let customers = [];       // Ù„ÛŒØ³Øª Ù…Ø´ØªØ±ÛŒâ€ŒÙ‡Ø§ Ø§Ø² Ø³Ø±ÙˆØ± (Ø¨Ø±Ø§ÛŒ Ø¬Ø³ØªØ¬ÙˆÛŒ Ù…Ø­Ù„ÛŒ)
let invoiceItems = [];    // Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§ÛŒ ÙØ§Ú©ØªÙˆØ± Ø¯Ø± Ø­Ø§ÙØ¸Ù‡

function toJalali(dateStr){
  try {
    return new persianDate(new Date(dateStr)).format("YYYY/MM/DD HH:mm:ss");
  } catch {
    return dateStr;
  }
}

/* ====== helper debounce ====== */
function debounce(fn, wait=250){
  let t;
  return (...args)=>{
    clearTimeout(t);
    t = setTimeout(()=>fn(...args), wait);
  }
}

/* ====== Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ POS ====== */
async function sendToPOS() {
  const totalText = document.getElementById("totalSpan").innerText;
  const amount = Number(totalText.replace(/,/g, ""));

  if (!amount || amount <= 0) {
    alert("Ù…Ø¨Ù„Øº Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª");
    return;
  }

  const orderId = "INV-" + Date.now();

  const payload = {
    ConnectionType: "Lan",
    DeviceIp: "192.168.1.20",   // ğŸ”´ IP Ú©Ø§Ø±Øªâ€ŒØ®ÙˆØ§Ù† (Ø§Ø² Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ú¯Ø±ÙØªÛŒ)
    DevicePort: "8009",
    Amount: amount,            // Ø±ÛŒØ§Ù„
    OrderId: orderId,
    SaleId: orderId,
    DeviceType: "0"            // BlueBird
  };

  try {
    const res = await fetch("http://localhost:8000/api/Sale", {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded"
      },
      body: JSON.stringify(payload)
    });

    const data = await res.json();
    console.log("PCPOS:", data);

    if (data && data.Status === "Success") {
      alert("âœ… Ù¾Ø±Ø¯Ø§Ø®Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯");
      // Ø§ÛŒÙ†Ø¬Ø§ Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ Ø¨Ø¹Ø¯Ø´ createInvoiceBtn Ø±Ùˆ Ø®ÙˆØ¯Ú©Ø§Ø± Ø¨Ø²Ù†ÛŒ
    } else {
      alert("âŒ Ù¾Ø±Ø¯Ø§Ø®Øª Ù†Ø§Ù…ÙˆÙÙ‚");
    }

  } catch (err) {
    console.error(err);
    alert("âŒ Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø¯Ø³ØªÚ¯Ø§Ù‡ POS Ø¨Ø±Ù‚Ø±Ø§Ø± Ù†Ø´Ø¯");
  }
}

/* ====== Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ù…Ø­ØµÙˆÙ„Ø§Øª Ùˆ Ù…Ø´ØªØ±ÛŒâ€ŒÙ‡Ø§ ====== */
async function loadInitialData(){
  await Promise.all([ loadProductsForSelect(), loadCustomersList() ]);
}
async function loadProductsForSelect(){
  try {
    const res = await fetch(apiProducts);
    if(!res.ok) throw new Error('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù…Ø­ØµÙˆÙ„Ø§Øª');
    products = await res.json();
    // no select element now â€” products used by suggestions
  } catch(err){
    console.error('loadProductsForSelect:', err);
    products = [];
  }
}
async function loadCustomersList(){
  try {
    const res = await fetch(apiCustomers);
    if(!res.ok) throw new Error('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù…Ø´ØªØ±ÛŒØ§Ù†');
    customers = await res.json();
  } catch(err){
    console.error('loadCustomersList:', err);
    customers = [];
  }
}

/* ====== CUSTOMER: searchable input behavior ====== */
const customerInput = document.getElementById('customerInput');
const customerSuggestions = document.getElementById('customerSuggestions');
const selectedCustomerIdEl = document.getElementById('selectedCustomerId');

function showCustomerSuggestions(list){
  if(!list || list.length===0){
    customerSuggestions.style.display='none';
    customerSuggestions.innerHTML='';
    return;
  }
  customerSuggestions.innerHTML = list.map(c => `<div class="item" data-id="${c._id}" data-name="${escapeHtml(c.name)}">${escapeHtml(c.name)} â€” ${c.phone?escapeHtml(c.phone):'-'}</div>`).join('');
  customerSuggestions.style.display='block';
}
function filterCustomers(q){
  if(!q) { showCustomerSuggestions(customers.slice(0,8)); return; }
  const str = q.toLowerCase();
  const filtered = customers.filter(c => (c.name||'').toLowerCase().includes(str) || (c.phone||'').toLowerCase().includes(str) || (String(c.id||'')).includes(str));
  showCustomerSuggestions(filtered.slice(0,12));
}
customerInput.addEventListener('input', debounce((e)=>{
  selectedCustomerIdEl.value = ''; // typing => clear previously selected id
  filterCustomers(e.target.value);
},200));
customerInput.addEventListener('focus', ()=> filterCustomers(customerInput.value) );

// Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ù…Ø´ØªØ±ÛŒ
customerSuggestions.addEventListener('click', (ev)=>{
  const it = ev.target.closest('.item');
  if(!it) return;
  const id = it.dataset.id;
  const name = it.dataset.name;
  customerInput.value = name;
  selectedCustomerIdEl.value = id;
  customerSuggestions.style.display='none';
});

// Ú©Ù„ÛŒÚ© Ø¨ÛŒØ±ÙˆÙ† => Ù¾Ù†Ù‡Ø§Ù† Ú©Ø±Ø¯Ù† Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯Ù‡Ø§
document.addEventListener('click', (ev)=>{
  if(!ev.target.closest('.search-wrapper')) {
    customerSuggestions.style.display='none';
    productSuggestions.style.display='none';
  }
});

/* ====== PRODUCT: searchable input behavior ====== */
const productSearch = document.getElementById('productSearch');
const productSuggestions = document.getElementById('productSuggestions');



productSearch.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') {
    e.preventDefault();
    document.getElementById('addItemBtn').click();
  }
});

function showProductSuggestions(list){
  if(!list || list.length===0){
    productSuggestions.style.display='none';
    productSuggestions.innerHTML='';
    return;
  }
  productSuggestions.innerHTML = list.map(p => 
    `<div class="item" data-id="${p._id}" data-price="${p.price}" data-name="${escapeHtml(p.name)}">
      ${escapeHtml(p.name)} â€” ${Number(p.price).toLocaleString()} ØªÙˆÙ…Ø§Ù† â€” Ù…ÙˆØ¬ÙˆØ¯ÛŒ: ${p.stock}
    </div>`
  ).join('');
  productSuggestions.style.display='block';
}
function filterProducts(q){
  if(!q) { showProductSuggestions(products.slice(0,8)); return; }
  const str = q.toLowerCase();
  const filtered = products.filter(p => (p.name||'').toLowerCase().includes(str) || (String(p.sku||'')).toLowerCase().includes(str));
  if (filtered.length === 1) {
    lastSelectedProduct = filtered[0];
  }
  showProductSuggestions(filtered.slice(0,12));
}
productSearch.addEventListener('input', debounce((e)=>{
  filterProducts(e.target.value);
},200));
productSearch.addEventListener('focus', ()=> filterProducts(productSearch.value) );

// ÙˆÙ‚ØªÛŒ Ù…Ø­ØµÙˆÙ„ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯
let lastSelectedProduct = null; // {id, price, name}
productSuggestions.addEventListener('click', (ev)=>{
  const it = ev.target.closest('.item');
  if(!it) return;
  const id = Number(it.dataset._id);
  const price = Number(it.dataset.price);
  const name = it.dataset.name;
  lastSelectedProduct = { id, price, name };
  productSearch.value = name;
  productSuggestions.style.display='none';
});

/* ====== Ø§ÙØ²ÙˆØ¯Ù† Ø¢ÛŒØªÙ… Ø¨Ù‡ ÙØ§Ú©ØªÙˆØ± ====== */
document.getElementById('addItemBtn').addEventListener('click', ()=> {
  // find selected product either from lastSelectedProduct or exact name match
  const qty = Math.max(1, Number(document.getElementById('productQty').value || 1));
  let product = null;
  if(lastSelectedProduct) {
    product = products.find(p => p._id === lastSelectedProduct._id);
  }
  if(!product) {
    // try find by exact name search
    const q = productSearch.value.trim().toLowerCase();
    product = products.find(p => (p.name||'').toLowerCase() === q || (String(p.sku||'') === q));
  }
  if(!product) return alert('Ù…Ø­ØµÙˆÙ„ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡ ÛŒØ§ ØµØ­ÛŒØ­ Ù†ÛŒØ³Øª');
  if(product.stock < qty) return alert('Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©Ø§ÙÛŒ Ù†ÛŒØ³Øª');

  const existing = invoiceItems.find(i=>i.product_id===product._id);
  if(existing) existing.quantity += qty;
  else invoiceItems.push({ product_id: product._id, name: product.name, price: Number(product.price), quantity: qty });
  // reset product input
  productSearch.value = '';
  lastSelectedProduct = null;
  renderInvoiceItems();
  resetProductEntry();
  document.getElementById('addItemBtn').classList.add('btn-success');
  setTimeout(()=> {
    document.getElementById('addItemBtn').classList.remove('btn-success');
  }, 200);
});

function resetProductEntry() {
  productSearch.value = '';
  document.getElementById('productQty').value = 1;
  lastSelectedProduct = null;
  productSearch.focus();
}

let lastKeyTime = Date.now();

document.addEventListener('keydown', (e) => {
  const now = Date.now();
  if (now - lastKeyTime > 50) barcodeBuffer = '';
  lastKeyTime = now;

  if (e.key === 'Enter') {
    handleBarcode(barcodeBuffer);
    barcodeBuffer = '';
  } else {
    barcodeBuffer += e.key;
  }
});

/* --- ØªØ´Ø®ÛŒØµ Ø¨Ø§Ø±Ú©Ø¯ Ø§Ø³Ú©Ù† (Heroje NB271) --- */
let barcodeBuffer = '';

document.addEventListener('keypress', async (e) => {
  // Ø§Ú¯Ø± Ù…ÙˆØ¯Ø§Ù„ ÙØ§Ú©ØªÙˆØ± Ø¨Ø§Ø² Ù†ÛŒØ³ØªØŒ Ú©Ø§Ø±ÛŒ Ù†Ú©Ù†
  const modal = document.getElementById('createInvoiceModal');
  if (!modal.classList.contains('show')) return;

  // Ø§Ú¯Ø± Ø¨Ø§Ø±Ú©Ø¯Ø®ÙˆØ§Ù† Ú†ÛŒØ²ÛŒ ÙˆØ§Ø±Ø¯ Ú©Ø±Ø¯ (ØºØ§Ù„Ø¨Ø§Ù‹ Ø³Ø±ÛŒØ¹ Ùˆ Ù¾Ø´Øªâ€ŒØ³Ø±Ù‡Ù…)
  if (e.key === 'Enter') {
    const code = barcodeBuffer.trim();
    barcodeBuffer = '';
    if (!code) return;

    // Ø­Ø§Ù„Ø§ Ú©Ø¯ Ù…Ø­ØµÙˆÙ„ (sku) Ø±Ø§ Ù¾ÛŒØ¯Ø§ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
    const product = products.find(p => String(p.sku) === code || `SKU:${p.sku}` === code);
    if (!product) {
      alert('âŒ Ù…Ø­ØµÙˆÙ„ÛŒ Ø¨Ø§ Ø§ÛŒÙ† Ú©Ø¯ ÛŒØ§ÙØª Ù†Ø´Ø¯');
      return;
    }

    // Ø¨Ø±Ø±Ø³ÛŒ Ù…ÙˆØ¬ÙˆØ¯ÛŒ
    const qty = 1;
    if (product.stock < qty) {
      alert('âš ï¸ Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©Ø§ÙÛŒ Ù†ÛŒØ³Øª');
      return;
    }

    // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¨Ù‡ ÙØ§Ú©ØªÙˆØ±
    const existing = invoiceItems.find(i => i.product_id === product.id);
    if (existing) existing.quantity += qty;
    else invoiceItems.push({ product_id: product.id, name: product.name, price: product.price, quantity: qty });
    
    renderInvoiceItems();
  } else {
    barcodeBuffer += e.key;
  }
});

/* ====== Ø±Ù†Ø¯Ø± Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§ ====== */
function renderInvoiceItems(){
  const tbody = document.getElementById('invoiceItemsTbody');
  tbody.innerHTML = invoiceItems.map((it, idx)=>`
    <tr>
      <td>${idx+1}</td>
      <td>${escapeHtml(it.name)}</td>
      <td><input type="number" min="1" value="${it.quantity}" class="form-control item-qty" data-idx="${idx}"></td>
      <td>${Number(it.price).toLocaleString()}</td>
      <td>${Number(it.price * it.quantity).toLocaleString()}</td>
      <td><button class="btn btn-sm btn-danger remove-item" data-idx="${idx}">Ø­Ø°Ù</button></td>
    </tr>
  `).join('');
  // event handlers
  document.querySelectorAll('.remove-item').forEach(btn=>{
    btn.onclick = ()=>{ invoiceItems.splice(Number(btn.dataset.idx),1); renderInvoiceItems() }
  });
  document.querySelectorAll('.item-qty').forEach(inp=>{
    inp.onchange = ()=>{
      const idx = Number(inp.dataset.idx);
      const val = Math.max(1, Number(inp.value||1));
      const prod = products.find(p=>p._id===invoiceItems[idx].product_id);
      if (prod && val > prod.stock) {
        alert('Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©Ø§ÙÛŒ Ù†ÛŒØ³Øª'); inp.value = invoiceItems[idx].quantity; return;
      }
      invoiceItems[idx].quantity = val;
      renderInvoiceItems();
    }
  });
  recalcTotals();
}

/* ====== Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¬Ù…Ø¹â€ŒÙ‡Ø§ ====== */
function recalcTotals(){
  const subtotal = invoiceItems.reduce((s,i)=>s + i.price * i.quantity, 0);
  const tax = Number(document.getElementById('taxInput').value || 0);
  const discount = Number(document.getElementById('discountInput').value || 0);
  const total = subtotal + tax - discount;
  document.getElementById('subtotalSpan').innerText = Number(subtotal).toLocaleString();
  document.getElementById('taxSpan').innerText = Number(tax).toLocaleString();
  document.getElementById('discountSpan').innerText = Number(discount).toLocaleString();
  document.getElementById('totalSpan').innerText = Number(total).toLocaleString();
}
document.getElementById('taxInput').addEventListener('input', recalcTotals);
document.getElementById('discountInput').addEventListener('input', recalcTotals);

/* ====== Ø«Ø¨Øª ÙØ§Ú©ØªÙˆØ± (payload Ø´Ø§Ù…Ù„ customer_id Ø§Ú¯Ø± Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯) ====== */
document.getElementById('createInvoiceBtn').addEventListener('click', async ()=>{
  if (invoiceItems.length===0) return alert('Ù‡ÛŒÚ† Ø¢ÛŒØªÙ…ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ù†Ø´Ø¯Ù‡');
  const invoice_no = `INV-${Date.now()}`;
  const customer_name = document.getElementById('customerInput').value.trim() || '';
  const customer_id = document.getElementById('selectedCustomerId').value || null; // may be '' or id
  const tax = Number(document.getElementById('taxInput').value || 0);
  const discount = Number(document.getElementById('discountInput').value || 0);

  const payload = {
    invoice_no,
    customer_name,
    // include customer_id if selected (server may ignore if not implemented)
    ...(customer_id ? { customer_id: Number(customer_id) } : {}),
    tax,
    discount,
    items: invoiceItems.map(i=>({ product_id: i.product_id, quantity: i.quantity, price: i.price }))
  };

  try {
    const res = await fetch(apiInvoices, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) })
    const result = await res.json()
    if (result.success) {
      alert('âœ… ÙØ§Ú©ØªÙˆØ± Ø«Ø¨Øª Ø´Ø¯');
      bootstrap.Modal.getInstance(document.getElementById('createInvoiceModal')).hide();
      invoiceItems = [];
      await loadProductsForSelect();
      await loadCustomersList();
      loadInvoices();
    } else {
      alert('âŒ Ø®Ø·Ø§: ' + (result.error || 'Ø«Ø¨Øª ÙØ§Ú©ØªÙˆØ± Ù…ÙˆÙÙ‚ Ù†Ø¨ÙˆØ¯'));
    }
  } catch(err){
    console.error('create invoice error', err);
    alert('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ ÙØ§Ú©ØªÙˆØ± Ø¨Ù‡ Ø³Ø±ÙˆØ±');
  }
});

/* ====== Ù„ÛŒØ³Øª Ùˆ Ù†Ù…Ø§ÛŒØ´ ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ (Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±) ====== */

async function loadInvoices(){
  try {
    const res = await fetch(apiInvoices);
    const list = await res.json();
    const tbody = document.getElementById('invoicesTbody');
    const q = document.getElementById('invoiceSearch').value.toLowerCase();
    tbody.innerHTML = list.filter(inv =>
      String(inv._id).includes(q) || (inv.invoice_no||'').toLowerCase().includes(q) || (inv.customer_name||'').toLowerCase().includes(q)
    ).map((inv, index) => `
      <tr>
        <td>${index + 1}</td>
        <td>${inv.invoice_no || ''}</td>
        <td>${inv.customer_name || ''}</td>
        <td>${toJalali(inv.date)}</td>
        <td>${Number(inv.total).toLocaleString()}</td>
        <td>
          <button class="btn btn-sm btn-info" onclick="viewInvoice('${inv._id}')">ğŸ§¾ Ù†Ù…Ø§ÛŒØ´</button>
          <button class="btn btn-sm btn-danger" onclick="deleteInvoice('${inv._id}')">ğŸ—‘ Ø­Ø°Ù</button>
        </td>
      </tr>
    `).join('');
  } catch(err){
    console.error('loadInvoices error', err);
    alert('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÙØ§Ú©ØªÙˆØ±Ù‡Ø§');
  }
}

/* ====== Ù†Ù…Ø§ÛŒØ´ ÙØ§Ú©ØªÙˆØ± Ùˆ Ù¾Ø±ÛŒÙ†Øª ====== */
async function viewInvoice(id) {
  const res = await fetch(`${apiInvoices}/${id}`);
  const data = await res.json();

  if(!data.success) {
    alert('ÙØ§Ú©ØªÙˆØ± ÛŒØ§ÙØª Ù†Ø´Ø¯'); 
    return;
  }

  const { invoice } = data;
  const items = invoice.items || [];

  document.getElementById('invoiceDetails').innerHTML = `
    <div class="text-center mb-3">
      <h4>ğŸ§¾ ÙØ§Ú©ØªÙˆØ± Ø´Ù…Ø§Ø±Ù‡ ${invoice.invoice_no}</h4>
      <p>ğŸ‘¤ Ù…Ø´ØªØ±ÛŒ: ${invoice.customer_name || '-'}</p>
      <p>ğŸ“… ØªØ§Ø±ÛŒØ®: ${toJalali(invoice.date)}</p>
    </div>

    <table class="table table-bordered table-hover text-center align-middle">
      <thead class="table-success">
        <tr>
          <th id='numbercount'>#</th>
          <th>Ù…Ø­ØµÙˆÙ„</th>
          <th>ØªØ¹Ø¯Ø§Ø¯</th>
          <th>Ù‚ÛŒÙ…Øª ÙˆØ§Ø­Ø¯ (ØªÙˆÙ…Ø§Ù†)</th>
          <th>Ø¬Ù…Ø¹ (ØªÙˆÙ…Ø§Ù†)</th>
        </tr>
      </thead>
      <tbody>
        ${items.map((it, i) => `
          <tr>
            <td id='numbercount'>${i + 1}</td>
            <td>${it.product_name || it.product_id?.name || 'â€”'}</td>
            <td>${it.quantity}</td>
            <td>${Number(it.price).toLocaleString()}</td>
            <td>${(it.price * it.quantity).toLocaleString()}</td>
          </tr>
        `).join('')}
      </tbody>
    </table>

    <div class="text-end mt-3">
      <p>ğŸ§¾ Ø¬Ù…Ø¹ Ø¬Ø²Ø¡: ${Number(invoice.subtotal).toLocaleString()} ØªÙˆÙ…Ø§Ù†</p>
      <p>ğŸ”– ØªØ®ÙÛŒÙ: ${Number(invoice.discount).toLocaleString()} ØªÙˆÙ…Ø§Ù†</p>
      <p>ğŸ’° Ù…Ø§Ù„ÛŒØ§Øª: ${Number(invoice.tax).toLocaleString()}</p>
      <h5 class="fw-bold text-success mt-2">ğŸ’µ Ù…Ø¨Ù„Øº Ù†Ù‡Ø§ÛŒÛŒ: ${Number(invoice.total).toLocaleString()} ØªÙˆÙ…Ø§Ù†</h5>
    </div>

    <div class="text-center mt-4">
      <button class="btn btn-outline-primary" onclick="printInvoice('${invoice._id}')">ğŸ–¨ï¸ Ú†Ø§Ù¾ ÙØ§Ú©ØªÙˆØ±</button>
    </div>
  `;

  new bootstrap.Modal(document.getElementById('viewInvoiceModal')).show();
}

function printInvoice(id) {
  const content = document.getElementById('invoiceDetails').innerHTML;

  const w = window.open('', '', 'width=450,height=800');
  
  w.document.write(`
    <html lang="fa" dir="rtl">
    <head>
      <title>Ú†Ø§Ù¾ ÙØ§Ú©ØªÙˆØ±</title>

      <link href="assets/font/style.css" rel="stylesheet">
      <style>
        @page { size: 72mm 210mm; margin: 0; }

        body {
          margin: 0;
          padding: 5px;
          font-family: sans-serif;
        }

        .preview-box {
          width: 72mm;
          margin: auto;
        }

        table {
          width: 100%;
          border-collapse: collapse;
        }
        th, td {
          border: 1px solid #000;
          padding: 4px;
          font-size: 11px;
          text-align: center;
        }

        button { display:none; }
        #numbercount { display: none; }

        p {
            border: 1px solid #000;
            padding: 5px;
            font-size: small;
            margin:0;
        }
        h5 {
            background:#000;
            color:#fff;
            padding:5px;
            margin:0;
            text-align:center;
        }
        img {
            width: 100px;
            display: block;
            margin: 0 auto;
        }
      </style>
    </head>

    <body>

      <div class="preview-box">
        <img src="assets/img/logo.png">
        <h3 style="text-align:center">Â« Setaya Gallery Â»</h3>

        ${content}

        <div style="margin-top:20px; text-align:center; font-size:11px; border-top:1px dashed #aaa; padding-top:5px;">
          Ø¢Ø¯Ø±Ø³: Ù…Ù†Ø¸Ø±ÛŒÙ‡ØŒ Ù†Ø¨Ø´ Ú©ÙˆÚ†Ù‡ Ø¹Ù„ÙˆÙ…ÛŒ<br>
          Ø§ÛŒÙ†Ø³ØªØ§Ú¯Ø±Ø§Ù…: setaya_gallery
        </div>
      </div>

    </body>
    </html>
  `);

  w.document.close();

  // ğŸ”¥ Ø§Ø¬Ø±Ø§ÛŒ Ú†Ø§Ù¾ Ø®ÙˆØ¯Ú©Ø§Ø± Ø¨Ø¯ÙˆÙ† Ù†Ù…Ø§ÛŒØ´ ØµÙØ­Ù‡
  w.onload = () => {
    w.focus();
    w.print();
    w.close();
  };
}



/* ====== Ø­Ø°Ù ÙØ§Ú©ØªÙˆØ± ====== */
async function deleteInvoice(id){
  if (!confirm('Ø¢ÛŒØ§ Ø­Ø°Ù Ø´ÙˆØ¯ØŸ')) return;
  try {
    const res = await fetch(`${apiInvoices}/${id}`, { method:'DELETE' });
    const r = await res.json();
    if (r.success) { alert('âœ… Ø­Ø°Ù Ø´Ø¯'); loadInvoices(); }
    else alert('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù');
  } catch(err){
    console.error('deleteInvoice error', err);
    alert('Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù ÙØ§Ú©ØªÙˆØ±');
  }
}

/* ====== Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§ÛŒ Ú©Ù…Ú©ÛŒ ====== */
function escapeHtml(text){
  if(typeof text !== 'string') return text;
  return text.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#039;');
}

/* ====== init ====== */
(async ()=> {
  await loadInitialData();
  loadInvoices();
})();

</script>

<!-- mnu -->
<script src="assets/js/menu.js"></script>

</body>
</html>
