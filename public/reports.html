<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Ú¯Ø²Ø§Ø±Ø´ ÙØ§Ú©ØªÙˆØ±Ù‡Ø§</title>
  <link rel="icon" href="ico/favicon.ico" type="image/x-icon">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#000000">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<!-- Persian Date -->
  <link rel="stylesheet" href="https://unpkg.com/@majidh1/jalalidatepicker/dist/jalalidatepicker.min.css">
<script type="text/javascript" src="https://unpkg.com/@majidh1/jalalidatepicker/dist/jalalidatepicker.min.js"></script>
    
  <link href="style/style.css" rel="stylesheet">
  <!-- Ø¯Ø± head -->
<link rel="stylesheet" href="assets/css/menu.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <style>
    body { background:#f8fafc; color:#222; }
    .card { border-radius: 12px; box-shadow: 0 6px 18px rgba(0,0,0,0.05); }
    .table thead th {
        background: #ffffff;
        color: #000000;
        border: 1px solid #d3d3d3;
    }
    .badge-total { font-size: 1rem; }
    
    /* Ù†ÙˆØ§Ø± Ø¨Ø§Ù„Ø§ÛŒ ØµÙØ­Ù‡ */
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: linear-gradient(90deg, #F765AD, #F7BAC4);
        color: #fff;
        padding: 20px 30px;
        border-radius: 15px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
    }
    .page-header h1 {
      font-size: 1.6rem;
      font-weight: 600;
      margin: 0;
    }
    .btn-success {
      background: #f769ae;
    }
    button#exportPdfBtn:hover {
        background: #f769ae;
    }
    .btn-success:hover {
      background: #ffffff;
      color: #000;
    }
  </style>
</head>
<body>


<!-- Ø¯Ø± ØªÙ…Ø§Ù… ØµÙØ­Ø§Øª Ø¨Ø§Ù„Ø§ Ù‚Ø¨Ù„ Ø§Ø² <div class="container"> -->
<div id="navbar-placeholder"></div>



  <div class="container py-4">

  <div class="page-header shadow">
    <h1>ğŸ“Š Ú¯Ø²Ø§Ø±Ø´ ÙØ§Ú©ØªÙˆØ±Ù‡Ø§</h1>
    <i class="bi bi-box-seam fs-2"></i>
  </div>

    <!-- ÙÛŒÙ„ØªØ±Ù‡Ø§ -->
    <div class="card mb-4">
      <div class="card-body">
        <div class="row g-3 align-items-end">
          <div class="col-md-3">
            <label class="form-label">Ø§Ø² ØªØ§Ø±ÛŒØ®</label>
            <!-- Ø§Ø² ØªØ§Ø±ÛŒØ® -->
            <input id="startDate" data-jdp data-jdp-miladi-input="miladi_start" type="text" class="form-control">
            <input type="hidden" id="miladi_start">
          </div>
          <div class="col-md-3">
            <label class="form-label">ØªØ§ ØªØ§Ø±ÛŒØ®</label>
            <!-- ØªØ§ ØªØ§Ø±ÛŒØ® -->
            <input id="endDate" data-jdp data-jdp-miladi-input="miladi_end" type="text" class="form-control">
            <input type="hidden" id="miladi_end">
          </div>
            <div class="col-md-3">
              <label class="form-label">Ù…Ø´ØªØ±ÛŒ</label>
              <input list="customerList" id="customerInput" class="form-control" placeholder="Ù†Ø§Ù… Ù…Ø´ØªØ±ÛŒ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯">
              <datalist id="customerList">
                <!-- Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ Ø§Ø² Ø¬Ø§ÙˆØ§Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ù¾Ø± Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ -->
              </datalist>
            </div>
          <div class="col-md-3 d-grid">
            <button id="searchBtn" class="btn btn-success">ğŸ” Ø¬Ø³ØªØ¬Ùˆ</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Ø¢Ù…Ø§Ø± Ø®Ù„Ø§ØµÙ‡ -->
    <div class="row mb-4">
      <div class="col-md-6 mb-2">
        <div class="card p-3 text-center">
          <h6 class="mb-1">ØªØ¹Ø¯Ø§Ø¯ ÙØ§Ú©ØªÙˆØ±Ù‡Ø§</h6>
          <h3 id="totalInvoices">0</h3>
        </div>
      </div>
      <div class="col-md-6 mb-2">
        <div class="card p-3 text-center">
          <h6 class="mb-1">Ù…Ø¬Ù…ÙˆØ¹ Ù…Ø¨Ù„Øº Ú©Ù„</h6>
          <h3 id="totalAmount">0 ØªÙˆÙ…Ø§Ù†</h3>
        </div>
      </div>
    </div>

    <!-- Ø¬Ø¯ÙˆÙ„ -->
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <strong>Ù„ÛŒØ³Øª ÙØ§Ú©ØªÙˆØ±Ù‡Ø§</strong>
        <div>
          <button id="exportPdfBtn" class="btn btn-outline-success btn-sm me-2">ğŸ“„ Ø®Ø±ÙˆØ¬ÛŒ PDF</button>
          <button id="exportExcelBtn" class="btn btn-outline-primary btn-sm">ğŸ“˜ Ø®Ø±ÙˆØ¬ÛŒ Excel</button>
        </div>
      </div>
      <div class="table-responsive">
        <table class="table table-hover mb-0 text-center">
          <thead>
            <tr>
              <th>Ø±Ø¯ÛŒÙ</th>
              <th>Ø´Ù…Ø§Ø±Ù‡ ÙØ§Ú©ØªÙˆØ±</th>
              <th>Ù†Ø§Ù… Ù…Ø´ØªØ±ÛŒ</th>
              <th>ØªØ§Ø±ÛŒØ®</th>
              <th>Ù…Ø¨Ù„Øº Ú©Ù„</th>
              <th>Ù…Ø´Ø§Ù‡Ø¯Ù‡</th>
            </tr>
          </thead>
          <tbody id="reportTableBody"></tbody>
        </table>
      </div>
    </div>
  </div>

<!-- Modal -->
<div class="modal fade" id="invoiceModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title">Ù…Ø´Ø§Ù‡Ø¯Ù‡ ÙØ§Ú©ØªÙˆØ±</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">

        <div id="modalContent">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div>

      </div>
    </div>
  </div>
</div>

<script>
async function openInvoiceModal(id) {
  try {
    const res = await fetch(`http://localhost:3000/api/invoices/${id}`);
    const data = await res.json();

    if (!data.invoice) {
      document.getElementById("modalContent").innerHTML = "Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÙØ§Ú©ØªÙˆØ±";
      return;
    }

    const inv = data.invoice;
    const items = inv.items || [];   // â† Ù…Ù‡Ù…â€ŒØªØ±ÛŒÙ† Ø§ØµÙ„Ø§Ø­

    let html = `
      <p><strong>Ø´Ù…Ø§Ø±Ù‡ ÙØ§Ú©ØªÙˆØ±:</strong> ${inv.invoice_no || inv.id}</p>
      <p><strong>Ù…Ø´ØªØ±ÛŒ:</strong> ${inv.customer_name}</p>
      <p><strong>ØªØ§Ø±ÛŒØ®:</strong> ${new Date(inv.date).toLocaleDateString('fa-IR')}</p>
      <p><strong>Ù…Ø§Ù„ÛŒØ§Øª:</strong> ${Number(inv.tax).toLocaleString('fa-IR')}</p>
      <p><strong>ØªØ®ÙÛŒÙ:</strong> ${Number(inv.discount).toLocaleString('fa-IR')}</p>
      <p><strong>Ù…Ø¬Ù…ÙˆØ¹ Ú©Ù„:</strong> ${Number(inv.total).toLocaleString('fa-IR')}</p>

      <hr>
      <h5 class="text-success">Ø§Ù‚Ù„Ø§Ù… ÙØ§Ú©ØªÙˆØ±</h5>

      <div class="table-responsive">
        <table class="table table-bordered text-center">
          <thead>
            <tr>
              <th>#</th>
              <th>Ù…Ø­ØµÙˆÙ„</th>
              <th>ØªØ¹Ø¯Ø§Ø¯</th>
              <th>Ù‚ÛŒÙ…Øª ÙˆØ§Ø­Ø¯</th>
              <th>Ø¬Ù…Ø¹ Ú©Ù„</th>
            </tr>
          </thead>
          <tbody>
    `;

    items.forEach((it, index) => {
      html += `
        <tr>
          <td>${index + 1}</td>
          <td>${it.product_name || it.product_id?.name || 'â€”'}</td>
          <td>${it.quantity}</td>
          <td>${Number(it.price).toLocaleString('fa-IR')}</td>
          <td>${(it.quantity * it.price).toLocaleString('fa-IR')}</td>
        </tr>
      `;
    });

    html += `</tbody></table></div>`;

    document.getElementById("modalContent").innerHTML = html;

    const modal = new bootstrap.Modal(document.getElementById('invoiceModal'));
    modal.show();

  } catch (err) {
    console.error(err);
    alert("Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±");
  }
}


</script>


<script>
  const apiReports = 'http://localhost:3000/api/reports';
  const apiCustomers = 'http://localhost:3000/api/customers';
  let reportsData = [];

  document.addEventListener('DOMContentLoaded', async () => {
    await loadCustomers();
    await loadReports();
    document.getElementById('searchBtn').addEventListener('click', loadReports);
    document.getElementById('exportPdfBtn').addEventListener('click', exportToPDF);
    document.getElementById('exportExcelBtn').addEventListener('click', exportToExcel);
  });

async function loadCustomers(){
  try {
    const res = await axios.get(apiCustomers);
    const list = Array.isArray(res.data) ? res.data : [];
    const datalist = document.getElementById('customerList');
    list.forEach(c => {
      const opt = document.createElement('option');
      opt.value = c.name;  // ÙÙ‚Ø· Ù…Ù‚Ø¯Ø§Ø± Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø±
      datalist.appendChild(opt);
    });
  } catch (err) {
    console.error('loadCustomers error', err);
  }
}


  async function loadReports(){
    try {
      const startDateRaw = document.getElementById('miladi_start').value || '';
      const endDateRaw = document.getElementById('miladi_end').value || '';

      const startDate = startDateRaw.replaceAll('/', '-');
      const endDate = endDateRaw.replaceAll('/', '-');

      const customerId = document.getElementById('customerInput').value || 'all';

      const res = await axios.get(apiReports, { params: { startDate, endDate, customerId } });
      if (!res.data || !res.data.success) {
        throw new Error((res.data && res.data.error) ? res.data.error : 'Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ù†Ø´Ø¯');
      }

      reportsData = Array.isArray(res.data.data) ? res.data.data : [];
      renderTable(reportsData);

      const totalInvoices = Number(res.data.summary.totalInvoices || 0);
      const totalAmount = Number(res.data.summary.totalAmount || 0);

      document.getElementById('totalInvoices').textContent = totalInvoices;
      document.getElementById('totalAmount').textContent = totalAmount.toLocaleString('fa-IR') + ' ØªÙˆÙ…Ø§Ù†';
    } catch (err) {
      console.error('loadReports error:', err);
      alert('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§: ' + (err.message || err));
    }
  }

  function renderTable(data){
    const tbody = document.getElementById('reportTableBody');
    tbody.innerHTML = '';
    data.forEach((r, i) => {
      const cust = r.customer_name ? escapeHtml(String(r.customer_name)) : '-';
      // safe date
      let dateText = '-';
      if (r.date) {
        const dt = new Date(r.date);
        if (!isNaN(dt)) dateText = dt.toLocaleDateString('fa-IR');
      }
      const totalNum = Number(r.total || 0);
      tbody.innerHTML += `
        <tr>
          <td>${i+1}</td>
          <td>${escapeHtml(String(r.invoice_no || r.id || ''))}</td>
          <td>${cust}</td>
          <td>${dateText}</td>
          <td>${totalNum.toLocaleString('fa-IR')} ØªÙˆÙ…Ø§Ù†</td>
          <td>
            <button class="btn btn-sm btn-success" onclick="openInvoiceModal('${r.id}')">
              Ù…Ø´Ø§Ù‡Ø¯Ù‡
            </button>
          </td>
        </tr>
      `;
    });
  }

  // Export PDF (uses jsPDF)
  function exportToPDF(){
    try {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: 'p', unit: 'pt', format: 'a4' });
      doc.setFontSize(16);
      doc.text('Ú¯Ø²Ø§Ø±Ø´ ÙØ§Ú©ØªÙˆØ±Ù‡Ø§', 260, 40);

      doc.setFontSize(11);
      let y = 70;
      reportsData.forEach((r, i) => {
        const cust = r.customer_name || '-';
        const total = Number(r.total || 0).toLocaleString('fa-IR');
        let dateText = '-';
        if (r.date) {
          const dt = new Date(r.date);
          if (!isNaN(dt)) dateText = dt.toLocaleDateString('fa-IR');
        }
        const line = `${i+1}. ${cust} â€” ${total} ØªÙˆÙ…Ø§Ù† â€” ${dateText}`;
        doc.text(line, 40, y);
        y += 18;
        if (y > 760) { doc.addPage(); y = 40; }
      });

      doc.save('reports.pdf');
    } catch (err) {
      console.error('exportToPDF error:', err);
      alert('Ø®Ø·Ø§ Ø¯Ø± ØªÙˆÙ„ÛŒØ¯ PDF');
    }
  }

  // Export Excel (SheetJS)
  function exportToExcel(){
    try {
      const wsData = reportsData.map(r => {
        let dateText = '';
        if (r.date) {
          const dt = new Date(r.date);
          if (!isNaN(dt)) dateText = dt.toLocaleDateString('fa-IR');
        }
        return {
          'Ø´Ù…Ø§Ø±Ù‡ ÙØ§Ú©ØªÙˆØ±': r.invoice_no || r.id,
          'Ù†Ø§Ù… Ù…Ø´ØªØ±ÛŒ': r.customer_name || '-',
          'ØªØ§Ø±ÛŒØ®': dateText,
          'Ù…Ø¨Ù„Øº Ú©Ù„': Number(r.total || 0)
        };
      });
      const ws = XLSX.utils.json_to_sheet(wsData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Reports');
      XLSX.writeFile(wb, `reports_${Date.now()}.xlsx`);
    } catch (err) {
      console.error('exportToExcel error:', err);
      alert('Ø®Ø·Ø§ Ø¯Ø± ØªÙˆÙ„ÛŒØ¯ Ø§Ú©Ø³Ù„');
    }
  }

  function escapeHtml(text){
    if (typeof text !== 'string') return text;
    return text.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#039;');
  }
</script>

<!-- Persian Date -->
<script>
  jalaliDatepicker.startWatch();

document.querySelector("[data-jdp-miladi-input]").addEventListener("jdp:change", function (e) {
    var miladiInput = document.getElementById(this.getAttribute("data-jdp-miladi-input"));
    if (!this.value) {
        miladiInput.value = "";
        return;
    }
    var date = this.value.split("/");
    miladiInput.value = jalali_to_gregorian(date[0], date[1], date[2]).join("/")
});

function jalali_to_gregorian(jy, jm, jd) {
    jy = Number(jy);
    jm = Number(jm);
    jd = Number(jd);
    var gy = (jy <= 979) ? 621 : 1600;
    jy -= (jy <= 979) ? 0 : 979;
    var days = (365 * jy) + ((parseInt(jy / 33)) * 8) + (parseInt(((jy % 33) + 3) / 4))
        + 78 + jd + ((jm < 7) ? (jm - 1) * 31 : ((jm - 7) * 30) + 186);
    gy += 400 * (parseInt(days / 146097));
    days %= 146097;
    if (days > 36524) {
        gy += 100 * (parseInt(--days / 36524));
        days %= 36524;
        if (days >= 365) days++;
    }
    gy += 4 * (parseInt((days) / 1461));
    days %= 1461;
    gy += parseInt((days - 1) / 365);
    if (days > 365) days = (days - 1) % 365;
    var gd = days + 1;
    var sal_a = [0, 31, ((gy % 4 == 0 && gy % 100 != 0) || (gy % 400 == 0)) ? 29 : 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
    var gm
    for (gm = 0; gm < 13; gm++) {
        var v = sal_a[gm];
        if (gd <= v) break;
        gd -= v;
    }
    return [gy, gm, gd];
}
</script>

<!-- mnu -->
<script src="assets/js/menu.js"></script>

</body>
</html>
